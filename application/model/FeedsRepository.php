<?phpinclude "Feed.php";class FeedsRepository {protected $db;public function __construct(PDO $db) {    $this->db = $db;}private function read($row) {  $result     = new Feed(); $result->id = $row["id"]; $result->Image_link = $row[ "Image_link"]; $result->Image_title = $row[ "Image_title"]; $result->Image_url = $row[ "Image_url"]; $result->Image_width = $row[ "Image_width"]; $result->Image_height = $row[ "Image_height"]; $result->Imagelink = $row[ "Imagelink"]; $result->Permalink = $row[ "Permalink"]; $result->Title = $row[ "Title"]; $result->Description = $row[ "Description"]; $result->Sourcepermalink = $row[ "Sourcepermalink"]; $result->Sourcetitle = $row[ "Sourcetitle"]; $result->Date = $row[ "Date"]; $result->Categories = $row[ "Categories"];  return $result; }private function getById($id)  {  $sql = "SELECT "; $sql.= "IdFeed    as id, "; $sql.= "Image_link, ";  $sql.= "Image_title, ";  $sql.= "Image_url, ";  $sql.= "Image_width, ";  $sql.= "Image_height, ";  $sql.= "Imagelink, ";  $sql.= "Permalink, ";  $sql.= "Title, ";  $sql.= "Description, ";  $sql.= "Sourcepermalink, ";  $sql.= "Sourcetitle, ";  $sql.= "Date, ";  $sql.= "Categories ";  $sql.= "FROM Feeds       "; $sql.= " WHERE IdFeed = :id ";   $q = $this->db->prepare($sql);   $q->bindParam(":id", $id, PDO::PARAM_INT);   $q->execute();   $rows = $q->fetchAll(); $JSON=false; $q->closeCursor(); $q = null; if ( !$JSON )   return $rows[0]; else   return $this->read($rows[0]);}public function getAll($filter) {//$this->updteRSS(); $sBuscame = ""; if (isset( $filter["sBuscame"] ) )  if ( $filter[ "sBuscame"] != "" )   $sBuscame = "%".$filter["sBuscame"]."%"; $sOrdenaMe = "Date"; if (isset( $filter["sOrdenaMe"] ) )  if ( $filter[ "sOrdenaMe"] != "" )   $sOrdenaMe = $filter["sOrdenaMe"];    $pageIndex = 1; if (isset( $filter["pageIndex"] ) )  if ( $filter[ "pageIndex"] != "" )   $pageIndex = $filter["pageIndex"]; $pageSize = 10; if (isset( $filter["pageSize"] ) )  if ( $filter[ "pageSize"] != "" )   $pageSize = $filter["pageSize"]; $Inicio =0;      $sql  = "";       $sql .= "SELECT ";       $sql.= "IdFeed    as id, ";      $sql.= "Image_link, ";       $sql.= "Image_title, ";       $sql.= "Image_url, ";       $sql.= "Image_width, ";       $sql.= "Image_height, ";       $sql.= "Imagelink, ";       $sql.= "Permalink, ";       $sql.= "Title, ";       $sql.= "Description, ";       $sql.= "Sourcepermalink, ";       $sql.= "Sourcetitle, ";       $sql.= "Date, ";       $sql.= "Categories ";       $sql .= "FROM Feeds  ";      if ( $sBuscame != "" )      {      $sql.= " WHERE ";      $sql .= "(";      $sql .= " Image_link LIKE :sBuscame OR  " ;       $sql .= " Image_title LIKE :sBuscame OR  " ;       $sql .= " Image_url LIKE :sBuscame OR  " ;       $sql .= " Image_width LIKE :sBuscame OR  " ;       $sql .= " Image_height LIKE :sBuscame OR  " ;       $sql .= " Imagelink LIKE :sBuscame OR  " ;       $sql .= " Permalink LIKE :sBuscame OR  " ;       $sql .= " Title LIKE :sBuscame OR  " ;       $sql .= " Description LIKE :sBuscame OR  " ;       $sql .= " Sourcepermalink LIKE :sBuscame OR  " ;       $sql .= " Sourcetitle LIKE :sBuscame OR  " ;       $sql .= " Date LIKE :sBuscame OR  " ;       $sql .= " Categories  LIKE :sBuscame  " ;       $sql .= ")";      }       //SELECT * FROM `feeds` ORDER BY `feeds`.`Date` ASC        $sql.= " ORDER BY ".$sOrdenaMe ; /*Date Title Description Categories DESC*/             if( $pageIndex!= 0 && $pageSize !=0 )        $sql.= " LIMIT :TamPag OFFSET :Inicio ";      $q = $this->db->prepare($sql);     if( $sBuscame !="" )      $q->bindParam(":sBuscame",  $sBuscame    );          /*Para PDO se necesita pasar el numero de columna y no el nombre*/     //$q->bindValue(":sOrdenaMe",  $sOrdenaMe , PDO::PARAM_INT   );          if( $pageIndex!= 0 && $pageSize !=0 ){       $pageIndex = ($pageIndex-1>0 ? $pageIndex-1 : 0 );       $Inicio    = (1*$pageSize) *  ($pageIndex);      $q->bindValue(":TamPag", (int) $pageSize, PDO::PARAM_INT );      $q->bindValue(":Inicio", (int) $Inicio  , PDO::PARAM_INT );     }     $q->execute();     $rows = $q->fetchAll();     $JSON=false;     $q->closeCursor();     $q = null;     if ( !$JSON )      return $rows;     else     {       $result = array();       foreach($rows as $row) {         array_push($result, $this->read($row));};        return $result;     } }public function getCountAll($filter) { $sBuscame = ""; if (isset( $filter["sBuscame"] ) )  if ( $filter[ "sBuscame"] != "" )   $sBuscame = "%".$filter["sBuscame"]."%";      $sql  = "";       $sql .= "SELECT COUNT( IdFeed ) as unTotal FROM Feeds  ";  if ( $sBuscame != "" ) {      $sql.= " WHERE ";      $sql .= "(";      $sql .= " Image_link LIKE :sBuscame OR  " ;       $sql .= " Image_title LIKE :sBuscame OR  " ;       $sql .= " Image_url LIKE :sBuscame OR  " ;       $sql .= " Image_width LIKE :sBuscame OR  " ;       $sql .= " Image_height LIKE :sBuscame OR  " ;       $sql .= " Imagelink LIKE :sBuscame OR  " ;       $sql .= " Permalink LIKE :sBuscame OR  " ;       $sql .= " Title LIKE :sBuscame OR  " ;       $sql .= " Description LIKE :sBuscame OR  " ;       $sql .= " Sourcepermalink LIKE :sBuscame OR  " ;       $sql .= " Sourcetitle LIKE :sBuscame OR  " ;       $sql .= " Date LIKE :sBuscame OR  " ;       $sql .= " Categories  LIKE :sBuscame  " ;       $sql .= ")"; }      $q = $this->db->prepare($sql);     if( $sBuscame !="" )      $q->bindParam(":sBuscame",  $sBuscame    );     $q->execute();     $rows = $q->fetchAll();     $q->closeCursor();     $q = null;     return $rows[0][ "unTotal" ]; }public function insert($data) {      $sql  = "";       $sql .= "INSERT INTO  Feeds  ";       $sql .= "(";      $sql .= " Image_link, " ;       $sql .= " Image_title, " ;       $sql .= " Image_url, " ;       $sql .= " Image_width, " ;       $sql .= " Image_height, " ;       $sql .= " Imagelink, " ;       $sql .= " Permalink, " ;       $sql .= " Title, " ;       $sql .= " Description, " ;       $sql .= " Sourcepermalink, " ;       $sql .= " Sourcetitle, " ;       $sql .= " Date, " ;       $sql .= " Categories  " ;       $sql .= ")";      $sql  .= " VALUES ";       $sql .= "(";      $sql .= " :Image_link, " ;       $sql .= " :Image_title, " ;       $sql .= " :Image_url, " ;       $sql .= " :Image_width, " ;       $sql .= " :Image_height, " ;       $sql .= " :Imagelink, " ;       $sql .= " :Permalink, " ;       $sql .= " :Title, " ;       $sql .= " :Description, " ;       $sql .= " :Sourcepermalink, " ;       $sql .= " :Sourcetitle, " ;       $sql .= " :Date, " ;       $sql .= " :Categories " ;       $sql .= ")";      $q = $this->db->prepare($sql);//addslashes(urldecode($_ADD["Producto"])), // PorEsto//$Description= str_replace(' xmlns="http://www.w3.org/1999/xhtml"', '', $Description);                         //<div xmlns="http://www.w3.org/1999/xhtml">// Por esto//$Description = preg_replace("/<img[^>]+\>/i", " ", $Description); //$Description = preg_replace("/<img[^>]+\>/i", "(image) ", $Description); $Description= trim($data["Description"]) ;$Description =strip_tags($Description);$Description =str_replace("%", '&percnt;', $Description);//$Description =strip_tags($Description,"<xmlns>");//$Description=preg_replace('/<\?xhtml.*?\/>/im', '', $Description);// $Description=trim(preg_replace('xmlns="http://www.w3.org/1999/xhtml"', ' ', $Description)); //$Description=trim(preg_replace('xmlns="http://www.w3.org/1999/xhtml"', ' ', $Description));  //$Description=preg_replace('/<\?xmlns*?\/>', '', $Description); //$Description=preg_replace('/<img*?\/>', '', $Description); $Description= trim($Description) ;$Description= ltrim($Description,"\t") ;$Description= trim($Description,"\n") ;$Description= trim($Description,"\r") ;$Description= trim($Description,"\0" ) ;$Description= trim($Description,"\v" ) ;$Description= trim($Description, "\x00..\x1F") ;$Description = trim(preg_replace('/\s\s+/', ' ', $Description)); //$Description ="";utf8_decode(  //$Description =utf8_decode( $Description ); // PORESTO/*$Description= str_replace("<br ///>", '', $Description);//$Description= str_replace('</div>', '', $Description);//$Description= str_replace("<div ".chr(34).">", '', $Description); $Description=strip_tags($Description,"<br />"); $Description=strip_tags($Description,"<div>"); $Description=strip_tags($Description,"</div>");  $Description=strip_tags($Description,"<img>");  */$Description= urldecode(addslashes( $Description   ) );$Title = trim($data["Title"]) ;$Title =strip_tags($Title); // IPORTANTE  $Title =str_replace("%", '&percnt;', $Title); // REvizar entidades IMPORTANTE  $Title= trim($Title) ;$Title= ltrim($Title,"\t") ;$Title= trim($Title,"\n") ;$Title= trim($Title,"\r") ;$Title= trim($Title,"\0" ) ;$Title= trim($Title,"\v" ) ;$Title= trim($Title, "\x00..\x1F") ;$Title = trim(preg_replace('/\s\s+/', ' ', $Title));//$Title  = addslashes(urldecode( $Title) ) ;$Title= urldecode(addslashes( $Title   ) );// $des= htmlentities($des, ENT_QUOTES, "UTF-8");//$des="nada";      /* Convertiendo */      /* Del FEED*/ $Image_link    = addslashes(urldecode( $data["Image_link"]) ) ; $Image_title   = addslashes(urldecode( $data["Image_title"]) ) ; $Image_url     = addslashes(urldecode( $data["Image_url"]) ) ;  /* Del Item*/ $Imagelink      = addslashes(urldecode( $data["Imagelink"]) ) ; $Permalink      = addslashes(urldecode( $data["Permalink"]) ) ; //$Title          = addslashes(urldecode( $data["Title"]) ) ;                  $Sourcepermalink = addslashes(urldecode( $data["Sourcepermalink"]) ) ; $Sourcetitle     = addslashes(urldecode( $data["Sourcetitle"]) ) ;                        //$Description= "";      //$Title= "";                 $q->bindParam(":Image_link",     $Image_link       );       $q->bindParam(":Image_title",    $Image_title      );       $q->bindParam(":Image_url",      $Image_url        );       $q->bindParam(":Image_width",    $data["Image_width"]     , PDO::PARAM_INT  );       $q->bindParam(":Image_height",   $data["Image_height"]    , PDO::PARAM_INT  );       $q->bindParam(":Imagelink",      $Imagelink        );       $q->bindParam(":Permalink",      $Permalink        );       $q->bindParam(":Title",          $Title);       $q->bindParam(":Description",    $Description );      $q->bindParam(":Sourcepermalink",$Sourcepermalink);       $q->bindParam(":Sourcetitle",    $Sourcetitle);       $q->bindParam(":Date",           $data["Date"]             );       $q->bindParam(":Categories",     $data["Categories"]       );      $q->execute();     $UnId =$this->db->lastInsertId();     $q->closeCursor();     $q = null;     return $this->getById( $UnId ); }public function update($data) {      $sql  = "";       $sql .= "UPDATE Feeds SET ";       $sql .= " Image_link = :Image_link, " ;       $sql .= " Image_title = :Image_title, " ;       $sql .= " Image_url = :Image_url, " ;       $sql .= " Image_width = :Image_width, " ;       $sql .= " Image_height = :Image_height, " ;       $sql .= " Imagelink = :Imagelink, " ;       $sql .= " Permalink = :Permalink, " ;       $sql .= " Title = :Title, " ;       $sql .= " Description = :Description, " ;       $sql .= " Sourcepermalink = :Sourcepermalink, " ;       $sql .= " Sourcetitle = :Sourcetitle, " ;       $sql .= " Date = :Date, " ;       $sql .= " Categories = :Categories " ;       $sql  .= " WHERE IdFeed = :id ";       $q = $this->db->prepare($sql);      $q->bindParam(":Image_link", $data["Image_link"]  );       $q->bindParam(":Image_title", $data["Image_title"]  );       $q->bindParam(":Image_url", $data["Image_url"]  );       $q->bindParam(":Image_width", $data["Image_width"]  , PDO::PARAM_INT  );       $q->bindParam(":Image_height", $data["Image_height"]  , PDO::PARAM_INT  );       $q->bindParam(":Imagelink", $data["Imagelink"]  );       $q->bindParam(":Permalink", $data["Permalink"]  );       $q->bindParam(":Title", $data["Title"]  );       $q->bindParam(":Description", $data["Description"]  );       $q->bindParam(":Sourcepermalink", $data["Sourcepermalink"]  );       $q->bindParam(":Sourcetitle", $data["Sourcetitle"]  );       $q->bindParam(":Date", $data["Date"]  );       $q->bindParam(":Categories", $data["Categories"]  );      $q->bindParam(":id",  $data["id"],   PDO::PARAM_INT );     $q->execute();     $q->closeCursor();     $q = null;     return $this->getById( $data["id"]); }public function remove($id) { $sql    =  "DELETE FROM Feeds WHERE IdFeed = :id "; $q      = $this->db->prepare($sql); $q->bindParam(":id", $id, PDO::PARAM_INT); $q->execute(); $q->closeCursor(); $q = null;}public function removeAll() { $sql    =  "TRUNCATE TABLE Feeds; "; $q      = $this->db->prepare($sql); $q->execute(); $q->closeCursor(); $q = null;}//RSSReader/* LLAMAR DESDE UN BOTON*/public function updteRSS($sURL="https://www.yucatan.com.mx/feed"){include_once('RSS/RSSReader.php');     $RssLector = new RSSLector();   //$RssLector->DisplayAllRSSFrom($sURL);    if ( !$RssLector->getRSSPublicado($sURL) )       echo "<p>".$this->error."</p>";    else      foreach ($RssLector->RSS as $unRSS)       $this->insert($unRSS); }}?>